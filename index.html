<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>LIFFå®¿é¡Œç®¡ç†</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: "Helvetica", sans-serif;
  background: linear-gradient(135deg, #dbeafe, #eef2ff);
  margin: 0;
  padding: 0;
  text-align: center;
}

h1 {
  margin-top: 30px;
  font-size: 28px;
}

.card {
  background: #fff;
  margin: 20px auto;
  padding: 25px;
  width: 90%;
  max-width: 420px;
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

label {
  display: block;
  margin-top: 15px;
  font-size: 16px;
}

input, select, textarea {
  width: 100%;
  margin-top: 8px;
  padding: 10px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button {
  margin-top: 20px;
  padding: 14px;
  font-size: 18px;
  width: 100%;
  border: none;
  border-radius: 12px;
  background: #2563eb;
  color: #fff;
  cursor: pointer;
}

button:active {
  transform: scale(0.97);
}

.hidden {
  display: none;
}

.loading {
  font-size: 18px;
  margin-top: 40px;
}
</style>
</head>

<body>

<h1>ğŸ“˜ å®¿é¡Œç®¡ç†</h1>

<div id="loading" class="loading">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² -->
<div id="register" class="card hidden">
  <p>æœ€åˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’ã—ã¦ãã ã•ã„</p>
  <button onclick="registerUser()">ç™»éŒ²ã™ã‚‹</button>
</div>

<!-- å®¿é¡Œè¿½åŠ  -->
<div id="add" class="card hidden">
  <label>æ•™ç§‘</label>
  <select id="subject">
    <option>å›½èª</option>
    <option>æ•°å­¦</option>
    <option>è‹±èª</option>
    <option>ç†ç§‘</option>
    <option>ç¤¾ä¼š</option>
    <option>ç¾è¡“</option>
    <option>éŸ³æ¥½</option>
    <option>ãã®ä»–</option>
  </select>

  <label>å®¿é¡Œå†…å®¹</label>
  <textarea id="content" rows="4"></textarea>

  <label>æœŸé™</label>
  <input type="date" id="deadline">

  <button onclick="addHomework()">è¿½åŠ </button>
</div>

<!-- å®¿é¡Œå®Œäº† -->
<div id="complete" class="card hidden">
  <p>å®Œäº†ã—ãŸã‚‰ãƒã‚§ãƒƒã‚¯</p>
  <div id="taskList"></div>
  <button onclick="completeHomework()">å®Œäº†ç™»éŒ²</button>
</div>

<script>
const LIFF_ID = '2008725002-jHJsEKRx';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbz910FJbvEKdMV-8dEGncfx2YocZHmNVeuyZHRA26c6SmqEaBEgPzwURfl1fQonvpTbpQ/exec';

let userId = '';
let page = 'register';

function qs(id){ return document.getElementById(id); }

function show(id){
  ['register','add','complete'].forEach(p=>qs(p).classList.add('hidden'));
  qs(id).classList.remove('hidden');
}

async function init(){
  await liff.init({ liffId: LIFF_ID });
  userId = liff.getContext().userId;

  const params = new URLSearchParams(location.search);
  page = params.get('page') || 'register';

  const res = await fetch(`${GAS_URL}?type=check&userId=${userId}`);
  const data = await res.json();

  qs('loading').classList.add('hidden');

  if(!data.registered){
    show('register');
  } else {
    show(page);
    if(page === 'complete') loadTasks();
  }
}

async function registerUser(){
  await fetch(GAS_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({type:'register',userId})
  });
  setTimeout(()=>liff.closeWindow(),2000);
}

async function addHomework(){
  await fetch(GAS_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      type:'addHomework',
      userId,
      subject:qs('subject').value,
      content:qs('content').value,
      deadline:qs('deadline').value
    })
  });
  setTimeout(()=>liff.closeWindow(),2000);
}

async function loadTasks(){
  const res = await fetch(`${GAS_URL}?type=list&userId=${userId}`);
  const tasks = await res.json();
  const box = qs('taskList');
  box.innerHTML = '';
  tasks.forEach(t=>{
    const d = document.createElement('div');
    d.innerHTML = `<label><input type="checkbox" value="${t}"> ${t}</label>`;
    box.appendChild(d);
  });
}

async function completeHomework(){
  const done = Array.from(document.querySelectorAll('input[type=checkbox]:checked'))
    .map(c=>c.value);
  await fetch(GAS_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({type:'complete',userId,done})
  });
  setTimeout(()=>liff.closeWindow(),2000);
}

init();
</script>
</body>
</html>

