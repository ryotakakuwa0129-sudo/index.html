<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å®¿é¡Œç®¡ç† LIFF</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: system-ui;
  background: #f5f6f8;
  padding: 16px;
}
.card {
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}
.hidden { display: none; }
button {
  width: 100%;
  padding: 12px;
  background: #06c755;
  color: #fff;
  border: none;
  border-radius: 8px;
  margin-top: 10px;
}
select, input {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
}
.checkbox {
  display: flex;
  align-items: center;
  margin-top: 6px;
}
</style>
</head>

<body>

<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² -->
<div id="registerCard" class="card hidden">
  <h2>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h2>
  <button onclick="register()">ç™»éŒ²ã™ã‚‹</button>
</div>

<!-- å®¿é¡Œè¿½åŠ  -->
<div id="addCard" class="card hidden">
  <h2>ğŸ“˜ å®¿é¡Œè¿½åŠ </h2>

  <select id="subject">
    <option value="">æ•™ç§‘ã‚’é¸æŠ</option>
    <option>å›½èª</option>
    <option>è‹±èª</option>
    <option>ç¤¾ä¼š</option>
    <option>æ•°å­¦</option>
    <option>ç†ç§‘</option>
    <option>ä¿ä½“</option>
    <option>ç¾è¡“</option>
    <option>éŸ³æ¥½</option>
    <option>ãã®ä»–</option>
  </select>

  <input id="text" placeholder="å®¿é¡Œå†…å®¹">
  <input id="date" type="date">
  <button onclick="addHomework()">è¿½åŠ </button>
</div>

<!-- å®Œäº†ç™»éŒ² -->
<div id="doneCard" class="card hidden">
  <h2>âœ… å®Œäº†ç™»éŒ²</h2>
  <div id="undoneList">èª­ã¿è¾¼ã¿ä¸­...</div>
  <button onclick="submitDone()">å®Œäº†ã«ã™ã‚‹</button>
</div>

<script>
const LIFF_ID = "2008725002-jHJsEKRx";
const GAS_URL = "https://script.google.com/macros/s/AKfycbz910FJbvEKdMV-8dEGncfx2YocZHmNVeuyZHRA26c6SmqEaBEgPzwURfl1fQonvpTbpQ/exec";

let userId = "";
let undoneList = [];

const qs = id => document.getElementById(id);
const show = id => {
  ["registerCard","addCard","doneCard"].forEach(i => qs(i).classList.add("hidden"));
  qs(id).classList.remove("hidden");
};

async function api(data){
  const res = await fetch(GAS_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(data)
  });
  return res.json();
}

async function init(){
  try {
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isLoggedIn()){
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    userId = profile.userId;

    const mode = new URLSearchParams(location.search).get("mode") || "add";

    // ç™»éŒ²åˆ¤å®š
    const check = await api({ action:"checkUser", userId });
    if(!check.registered){
      show("registerCard");
      return;
    }

    if(mode === "done"){
      show("doneCard");
      await loadUndone();
    } else {
      show("addCard");
    }

  } catch(e){
    document.body.innerHTML = `<pre>${e}</pre>`;
  }
}

async function register(){
  await api({ action:"register", userId });
  liff.closeWindow();
}

async function addHomework(){
  const s = qs("subject").value;
  const t = qs("text").value;
  const d = qs("date").value;
  if(!s || !t || !d){
    alert("ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  await api({
    action:"addHomework",
    userId,
    text:`${s}:${t}ï¼ˆæœŸé™${d}ï¼‰`
  });

  liff.closeWindow();
}

async function loadUndone(){
  undoneList = await api({ action:"getUndoneHomework", userId });
  const area = qs("undoneList");
  area.innerHTML = "";

  if(!undoneList.length){
    area.textContent = "æœªå®Œäº†ã®å®¿é¡Œã¯ã‚ã‚Šã¾ã›ã‚“";
    return;
  }

  undoneList.forEach((t,i)=>{
    area.innerHTML += `
      <div class="checkbox">
        <input type="checkbox" id="c${i}">
        <label for="c${i}">${t}</label>
      </div>`;
  });
}

async function submitDone(){
  for(let i=0;i<undoneList.length;i++){
    if(qs("c"+i).checked){
      await api({ action:"doneHomework", userId, text:undoneList[i] });
    }
  }
  liff.closeWindow();
}

init();
</script>
</body>
</html>

