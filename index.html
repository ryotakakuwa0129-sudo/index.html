<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>LIFFå®¿é¡Œç®¡ç†</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 420px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
      text-align: left;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      width: 100%;
      margin-top: 16px;
      padding: 14px;
      border: none;
      border-radius: 10px;
      background: #4f46e5;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    button.secondary {
      background: #16a34a;
    }
    .hidden {
      display: none;
    }
    .status {
      margin-top: 16px;
      font-size: 14px;
      color: #555;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>ğŸ“˜ å®¿é¡Œç®¡ç†</h1>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² -->
  <div id="registerCard" class="card hidden">
    <p>æœ€åˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’è¡Œã„ã¾ã™ã€‚</p>
    <button id="registerBtn">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</button>
  </div>

  <!-- å®¿é¡Œè¿½åŠ  -->
  <div id="addCard" class="card hidden">
    <label for="subject">æ•™ç§‘</label>
    <select id="subject" name="subject">
      <option value="å›½èª">å›½èª</option>
      <option value="æ•°å­¦">æ•°å­¦</option>
      <option value="è‹±èª">è‹±èª</option>
      <option value="ç†ç§‘">ç†ç§‘</option>
      <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
      <option value="ç¾è¡“">ç¾è¡“</option>
      <option value="éŸ³æ¥½">éŸ³æ¥½</option>
      <option value="ãã®ä»–">ãã®ä»–</option>
    </select>

    <label for="content">å®¿é¡Œå†…å®¹</label>
    <textarea id="content" name="content" rows="4"></textarea>

    <label for="deadline">æœŸé™</label>
    <input type="date" id="deadline" name="deadline">

    <button id="addBtn" class="secondary">å®¿é¡Œã‚’è¿½åŠ </button>
  </div>

  <div id="status" class="status">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
</div>

<script>
/* ===== è¨­å®š ===== */
const LIFF_ID = "2008725002-jHJsEKRx";
const GAS_URL = "https://script.google.com/macros/s/AKfycbz910FJbvEKdMV-8dEGncfx2YocZHmNVeuyZHRA26c6SmqEaBEgPzwURfl1fQonvpTbpQ/exec";

/* ===== å¤‰æ•° ===== */
let userId = null;

/* ===== åˆæœŸåŒ– ===== */
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    userId = liff.getContext().userId;
    checkUser();
  } catch (e) {
    document.getElementById("status").textContent = "LIFFåˆæœŸåŒ–å¤±æ•—";
  }
}

/* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª ===== */
async function checkUser() {
  const res = await fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "checkUser",
      userId: userId
    })
  });
  const data = await res.json();

  document.getElementById("status").textContent = "";

  if (data.registered) {
    document.getElementById("addCard").classList.remove("hidden");
  } else {
    document.getElementById("registerCard").classList.remove("hidden");
  }
}

/* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² ===== */
document.getElementById("registerBtn").addEventListener("click", async () => {
  document.getElementById("status").textContent = "ç™»éŒ²ä¸­â€¦";
  await fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "register",
      userId: userId
    })
  });
  document.getElementById("status").textContent = "ç™»éŒ²å®Œäº†ï¼";
  setTimeout(() => liff.closeWindow(), 2000);
});

/* ===== å®¿é¡Œè¿½åŠ  ===== */
document.getElementById("addBtn").addEventListener("click", async () => {
  const subject = document.getElementById("subject").value;
  const content = document.getElementById("content").value;
  const deadline = document.getElementById("deadline").value;

  if (!content || !deadline) {
    alert("å†…å®¹ã¨æœŸé™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  document.getElementById("status").textContent = "é€ä¿¡ä¸­â€¦";

  await fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "addHomework",
      userId,
      subject,
      content,
      deadline
    })
  });

  document.getElementById("status").textContent = "å®¿é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸï¼";
  setTimeout(() => liff.closeWindow(), 2000);
});

/* ===== èµ·å‹• ===== */
init();
</script>
</body>
</html>

