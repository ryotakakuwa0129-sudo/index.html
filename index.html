<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å®¿é¡Œç®¡ç† LIFF</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: #f5f6f8;
  margin: 0;
  padding: 16px;
}
.card {
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,.08);
}
h2 {
  margin-top: 0;
}
input, button {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  font-size: 16px;
}
button {
  background: #06c755;
  color: #fff;
  border: none;
  border-radius: 8px;
}
.checkbox {
  display: flex;
  align-items: center;
  margin-top: 8px;
}
.checkbox input {
  width: auto;
  margin-right: 8px;
}
.hidden {
  display: none;
}
</style>
</head>

<body>

<div class="card">
  <h2>ğŸ“˜ å®¿é¡Œè¿½åŠ </h2>
  <input id="homeworkText" placeholder="å®¿é¡Œå†…å®¹" />
  <input id="deadline" type="date" />
  <button onclick="addHomework()">è¿½åŠ </button>
</div>

<div class="card">
  <h2>âœ… å®Œäº†ç™»éŒ²</h2>
  <div id="undoneList">èª­ã¿è¾¼ã¿ä¸­...</div>
  <button onclick="submitDone()">å®Œäº†ã«ã™ã‚‹</button>
</div>

<script>
const LIFF_ID = "2008725002-jHJsEKRx";
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbz910FJbvEKdMV-8dEGncfx2YocZHmNVeuyZHRA26c6SmqEaBEgPzwURfl1fQonvpTbpQ/exec";

let userId = "";
let undoneHomework = [];

async function init() {
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  userId = profile.userId;

  // ğŸ”½ è‡ªå‹•ç™»éŒ²
  await postApi({ action: "register", userId });

  // ğŸ”½ æœªå®Œäº†å®¿é¡Œå–å¾—
  await loadUndone();
}

async function postApi(data) {
  await fetch(GAS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
}

async function postApiJson(data) {
  const res = await fetch(GAS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  return await res.json();
}

/***************
 * å®¿é¡Œè¿½åŠ 
 ***************/
async function addHomework() {
  const text = document.getElementById("homeworkText").value.trim();
  const date = document.getElementById("deadline").value;

  if (!text || !date) {
    alert("å®¿é¡Œã¨æœŸé™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const formatted = `${text}ï¼ˆæœŸé™${date}ï¼‰`;

  await postApi({
    action: "addHomework",
    userId
  });

  alert("å®¿é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ");
  document.getElementById("homeworkText").value = "";
  document.getElementById("deadline").value = "";

  await loadUndone();
}

/***************
 * æœªå®Œäº†å®¿é¡Œå–å¾—
 ***************/
async function loadUndone() {
  undoneHomework = await postApiJson({
    action: "getUndoneHomework",
    userId
  });

  const area = document.getElementById("undoneList");
  area.innerHTML = "";

  if (!undoneHomework.length) {
    area.textContent = "æœªå®Œäº†ã®å®¿é¡Œã¯ã‚ã‚Šã¾ã›ã‚“";
    return;
  }

  undoneHomework.forEach((t, i) => {
    const div = document.createElement("div");
    div.className = "checkbox";
    div.innerHTML = `
      <input type="checkbox" id="chk${i}">
      <label for="chk${i}">${t}</label>
    `;
    area.appendChild(div);
  });
}

/***************
 * å®Œäº†ç™»éŒ²
 ***************/
async function submitDone() {
  const checks = document.querySelectorAll("input[type=checkbox]");
  const done = [];

  checks.forEach((c, i) => {
    if (c.checked) done.push(undoneHomework[i]);
  });

  if (!done.length) {
    alert("å®Œäº†ã™ã‚‹å®¿é¡Œã‚’é¸ã‚“ã§ãã ã•ã„");
    return;
  }

  for (const text of done) {
    await postApi({
      action: "doneHomework",
      userId,
      text
    });
  }

  alert("å®Œäº†ç™»éŒ²ã—ã¾ã—ãŸ");
  await loadUndone();
}

init();
</script>
</body>
</html>
