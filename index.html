<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å®¿é¡Œç®¡ç† LIFF</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: system-ui;
  background: #f5f6f8;
  padding: 16px;
}
.card {
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.hidden { display: none; }
button {
  width: 100%;
  padding: 12px;
  background: #06c755;
  color: #fff;
  border: none;
  border-radius: 8px;
  margin-top: 10px;
  font-size: 16px;
}
select, input {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  font-size: 16px;
}
.checkbox {
  display: flex;
  align-items: center;
  margin-top: 6px;
}
</style>
</head>
<body>

<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² -->
<div id="registerCard" class="card hidden">
  <h2>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h2>
  <button onclick="register()">ç™»éŒ²ã™ã‚‹</button>
</div>

<!-- å®¿é¡Œè¿½åŠ  -->
<div id="addCard" class="card hidden">
  <h2>ğŸ“˜ å®¿é¡Œè¿½åŠ </h2>
  <select id="subject">
    <option value="">æ•™ç§‘ã‚’é¸æŠ</option>
    <option value="å›½èª">å›½èª</option>
    <option value="è‹±èª">è‹±èª</option>
    <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
    <option value="æ•°å­¦">æ•°å­¦</option>
    <option value="ç†ç§‘">ç†ç§‘</option>
    <option value="ä¿ä½“">ä¿ä½“</option>
    <option value="ç¾è¡“">ç¾è¡“</option>
    <option value="éŸ³æ¥½">éŸ³æ¥½</option>
    <option value="U">U</option>
    <option value="ãã®ä»–">ãã®ä»–</option>
  </select>

  <input id="text" placeholder="å®¿é¡Œå†…å®¹">
  <input id="date" type="date">
  <button onclick="addHomework()">è¿½åŠ </button>
</div>

<!-- å®Œäº†ç™»éŒ² -->
<div id="doneCard" class="card hidden">
  <h2>âœ… å®Œäº†ç™»éŒ²</h2>
  <div id="undoneList">èª­ã¿è¾¼ã¿ä¸­...</div>
  <button onclick="submitDone()">å®Œäº†ã«ã™ã‚‹</button>
</div>

<script>
const LIFF_ID = "2008725002-jHJsEKRx";
const GAS_URL = "https://script.google.com/macros/s/AKfycbz910FJbvEKdMV-8dEGncfx2YocZHmNVeuyZHRA26c6SmqEaBEgPzwURfl1fQonvpTbpQ/exec";

let userId = "";
let undone = [];

function qs(id){ return document.getElementById(id); }

function show(id){
  ["registerCard","addCard","doneCard"].forEach(i=>qs(i).classList.add("hidden"));
  qs(id).classList.remove("hidden");
}

async function api(data){
  const res = await fetch(GAS_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(data)
  });
  return res.text();
}

async function apiJson(data){
  const res = await fetch(GAS_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(data)
  });
  return res.json();
}

async function init(){
  try {
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isLoggedIn()){
      liff.login();
      return;
    }

    const p = await liff.getProfile();
    userId = p.userId;

    const params = new URLSearchParams(location.search);
    const mode = params.get("mode") || "add";

    const check = await apiJson({ action:"checkUser", userId });
    if(!check.registered){
      show("registerCard");
      return;
    }

    if(mode==="done"){
      show("doneCard");
      loadUndone();
    }else{
      show("addCard");
    }

  } catch(e){
    document.body.innerHTML = "<pre>"+e+"</pre>";
  }
}

async function register(){
  await api({ action:"register", userId });
  liff.closeWindow();
}

async function addHomework(){
  const s = qs("subject").value;
  const t = qs("text").value;
  const d = qs("date").value;
  if(!s||!t||!d){ alert("å…¨éƒ¨å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  await api({ action:"addHomework", userId, subject:s, text:`${s}:${t}ï¼ˆæœŸé™${d}ï¼‰`, date:d });
  liff.closeWindow();
}

async function loadUndone(){
  undone = await apiJson({ action:"getUndoneHomework", userId });
  const area = qs("undoneList");
  area.innerHTML="";
  undone.forEach((t,i)=>{
    const div = document.createElement('div');
    div.className = "checkbox";
    const input = document.createElement('input');
    input.type="checkbox";
    input.id = `c${i}`;
    input.dataset.index = i;
    const label = document.createElement('label');
    label.htmlFor = `c${i}`;
    label.innerText = t;
    div.appendChild(input);
    div.appendChild(label);
    area.appendChild(div);
  });
}

async function submitDone(){
  const checked = [...document.querySelectorAll('#undoneList input:checked')];
  if(checked.length===0){ alert("é¸æŠã—ã¦ãã ã•ã„"); return; }
  for(let c of checked){
    const idx = c.dataset.index;
    await api({ action:"doneHomework", userId, text:undone[idx] });
  }
  liff.closeWindow();
}

init();
</script>
</body>
</html>


</body>
</html>

