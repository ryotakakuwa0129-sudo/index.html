<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LIFF å®¿é¡Œç®¡ç†</title>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f5f7fb;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 420px;
  margin: 0 auto;
  padding: 24px;
  text-align: center;
}
h1 { font-size: 22px; margin-bottom: 16px; }
label {
  display: block;
  margin-top: 14px;
  text-align: left;
  font-weight: bold;
}
input, select, textarea, button {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  font-size: 16px;
}
button {
  background: #06c755;
  color: #fff;
  border: none;
  border-radius: 6px;
}
.hidden { display: none; }
#status { margin-top: 20px; }
</style>
</head>

<body>
<div class="container">

<h1>ğŸ“˜ LIFFå®¿é¡Œç®¡ç†</h1>

<div id="loading">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<div id="register" class="hidden">
  <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå¿…è¦ã§ã™</p>
  <button id="registerBtn">ç™»éŒ²ã™ã‚‹</button>
</div>

<div id="homework" class="hidden">

  <label for="subject">æ•™ç§‘</label>
  <select id="subject" name="subject">
    <option>å›½èª</option>
    <option>æ•°å­¦</option>
    <option>ç†ç§‘</option>
    <option>ç¤¾ä¼š</option>
    <option>è‹±èª</option>
    <option>ç¾è¡“</option>
    <option>éŸ³æ¥½</option>
    <option>ãã®ä»–</option>
  </select>

  <label for="content">å†…å®¹</label>
  <textarea id="content" name="content"></textarea>

  <label for="deadline">æœŸé™</label>
  <input type="date" id="deadline" name="deadline"/>

  <button id="addBtn">å®¿é¡Œã‚’è¿½åŠ </button>
</div>

<div id="status"></div>

</div>

<script>
/* ===== è¨­å®š ===== */
const LIFF_ID = "2008725002-jHJsEKRx";
const GAS_URL = "https://script.google.com/macros/s/AKfycbz910FJbvEKdMV-8dEGncfx2YocZHmNVeuyZHRA26c6SmqEaBEgPzwURfl1fQonvpTbpQ/exec";

/* ===== å…±é€šPOST ===== */
async function post(data) {
  const res = await fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  return res.json();
}

/* ===== åˆæœŸåŒ– ===== */
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    window.USER_ID = profile.userId;

    const result = await post({
      action: "checkUser",
      userId: USER_ID
    });

    document.getElementById("loading").classList.add("hidden");

    if (result.registered) {
      document.getElementById("homework").classList.remove("hidden");
    } else {
      document.getElementById("register").classList.remove("hidden");
    }

  } catch (e) {
    document.getElementById("loading").innerText = "åˆæœŸåŒ–å¤±æ•—";
    console.error(e);
  }
}

/* ===== ç™»éŒ² ===== */
document.getElementById("registerBtn").onclick = async () => {
  await post({
    action: "register",
    userId: USER_ID
  });
  document.getElementById("register").classList.add("hidden");
  document.getElementById("homework").classList.remove("hidden");
};

/* ===== å®¿é¡Œè¿½åŠ  ===== */
document.getElementById("addBtn").onclick = async () => {
  const subject = document.getElementById("subject").value;
  const content = document.getElementById("content").value;
  const deadline = document.getElementById("deadline").value;

  if (!content || !deadline) {
    alert("å†…å®¹ã¨æœŸé™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  await post({
    action: "addHomework",
    userId: USER_ID,
    subject,
    content,
    deadline
  });

  document.getElementById("status").innerText = "ç™»éŒ²å®Œäº†ï¼";
  setTimeout(() => liff.closeWindow(), 2000);
};

init();
</script>
</body>
</html>

