<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å®¿é¡Œç®¡ç†</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { font-family: sans-serif; padding: 14px; }
h2 { text-align: center; }
button {
  width: 100%;
  padding: 12px;
  margin: 6px 0;
  font-size: 16px;
}
.subjects button {
  width: 48%;
  margin: 4px 1%;
}
.selected {
  background: #4caf50;
  color: white;
}
.hw { border-bottom: 1px solid #ccc; padding: 6px 0; }
.center { text-align: center; margin-top: 40px; }
.hidden { display: none; }
</style>
</head>

<body>
<h2>ğŸ“˜ å®¿é¡Œç®¡ç†</h2>
<div id="status" class="center">åˆæœŸåŒ–ä¸­â€¦</div>

<!-- HOME -->
<div id="home" class="hidden">
  <button onclick="go('add')">â• å®¿é¡Œè¿½åŠ </button>
  <button onclick="go('done')">â˜‘ å®¿é¡Œå®Œäº†</button>
</div>

<!-- REGISTER -->
<div id="register" class="hidden center">
  <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå¿…è¦ã§ã™</p>
  <button onclick="register()">ç™»éŒ²ã™ã‚‹</button>
</div>

<!-- ADD -->
<div id="add" class="hidden">
  <h3>â• å®¿é¡Œè¿½åŠ </h3>

  <p>æ•™ç§‘ã‚’é¸æŠ</p>
  <div class="subjects" id="subjects"></div>

  <input id="text" placeholder="å†…å®¹" style="width:100%;padding:8px;"><br><br>
  <input id="date" type="date" style="width:100%;padding:8px;"><br><br>

  <button onclick="addHomework()">è¿½åŠ </button>
  <button onclick="go('home')">æˆ»ã‚‹</button>
</div>

<!-- DONE -->
<div id="done" class="hidden">
  <h3>â˜‘ æœªå®Œäº†å®¿é¡Œ</h3>
  <div id="list"></div>
  <button onclick="doneHomework()">å®Œäº†ã«ã™ã‚‹</button>
  <button onclick="go('home')">æˆ»ã‚‹</button>
</div>

<script>
/************** è¨­å®š **************/
const GAS_URL = "ã€ã‚ãªãŸã®GAS WebApp URLã€‘";
const LIFF_ID = "ã€ã‚ãªãŸã®LIFF IDã€‘";

/************** å¤‰æ•° **************/
let userId = "";
let registered = false;
let selectedSubject = "";

/************** åˆæœŸåŒ– **************/
init();
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    userId = liff.getContext().userId;
    const res = await post({ action: "checkUser", userId });
    registered = res.registered;

    route();
  } catch (e) {
    document.getElementById("status").innerText = "åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼";
    console.error(e);
  }
}

/************** ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° **************/
function route() {
  hideAll();
  const mode = new URLSearchParams(location.search).get("mode") || "home";

  if (!registered && mode !== "register") {
    show("register");
    return;
  }

  show(mode);
  document.getElementById("status").innerText = "";

  if (mode === "add") renderSubjects();
  if (mode === "done") loadUndone();
}

function go(mode) {
  location.href = `?mode=${mode}`;
}

function hideAll() {
  ["home","add","done","register"].forEach(id =>
    document.getElementById(id).classList.add("hidden")
  );
}

function show(id) {
  document.getElementById(id).classList.remove("hidden");
}

/************** GASé€šä¿¡ **************/
async function post(data) {
  const res = await fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  return res.json();
}

/************** ç™»éŒ² **************/
async function register() {
  await post({ action: "register", userId });
  registered = true;
  go("home");
}

/************** æ•™ç§‘ **************/
function renderSubjects() {
  const list = ["å›½èª","æ•°å­¦","è‹±èª","ç†ç§‘","ç¤¾ä¼š","éŸ³æ¥½","ç¾è¡“","ä¿å¥ä½“è‚²","ãã®ä»–"];
  const box = document.getElementById("subjects");
  box.innerHTML = "";
  list.forEach(s => {
    const b = document.createElement("button");
    b.innerText = s;
    b.onclick = () => selectSubject(b, s);
    box.appendChild(b);
  });
}

function selectSubject(btn, s) {
  selectedSubject = s;
  [...document.querySelectorAll(".subjects button")]
    .forEach(b => b.classList.remove("selected"));
  btn.classList.add("selected");
}

/************** å®¿é¡Œè¿½åŠ  **************/
async function addHomework() {
  const text = document.getElementById("text").value;
  const date = document.getElementById("date").value;

  if (!selectedSubject || !text || !date) {
    alert("ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  await post({
    action: "addHomework",
    userId,
    subject: selectedSubject,
    text,
    date
  });

  alert("è¿½åŠ ã—ã¾ã—ãŸ");
  go("home");
}

/************** æœªå®Œäº† **************/
async function loadUndone() {
  const res = await post({ action: "getUndoneHomework", userId });
  const list = document.getElementById("list");
  list.innerHTML = "";

  res.forEach(t => {
    const d = document.createElement("div");
    d.className = "hw";
    d.innerHTML = `<label>
      <input type="checkbox" value="${t}"> ${t}
    </label>`;
    list.appendChild(d);
  });
}

async function doneHomework() {
  const checked = [...document.querySelectorAll("input[type=checkbox]:checked")]
    .map(c => c.value);

  if (!checked.length) {
    alert("é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  await post({ action: "doneHomework", userId, doneList: checked });
  alert("å®Œäº†ã—ã¾ã—ãŸ");
  go("home");
}
</script>
</body>
</html>

