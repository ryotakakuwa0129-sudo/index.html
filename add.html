<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="api.js"></script>
</head>

<body>
<div class="card">
<h2>➕ 宿題追加</h2>

<div id="status">読み込み中…</div>
<div class="subjects" id="subjects"></div>
<textarea id="text" placeholder="宿題内容"></textarea>
<input type="date" id="date">
<button id="sendBtn" onclick="send()">登録</button>
</div>

<script>
const SUBJECTS=["国語","数学","理科","社会","英語","音楽","美術","保体","その他"];
let subject=null;
let userId;

async function init(){
  await liff.init({ liffId:"2008725002-jHJsEKRx" });
  const profile = await liff.getProfile();
  userId = profile.userId;

  const res = await post({ action: "checkUser", userId });
  const statusEl = document.getElementById("status");
  const sendBtn = document.getElementById("sendBtn");

  if(res.registered){
    statusEl.innerText = "✅ 登録済み";
    sendBtn.disabled = false;
  } else {
    statusEl.innerHTML = "⚠️ 未登録です。<br>登録ページに移動します";
    sendBtn.disabled = true;
    setTimeout(()=>location.href="register.html", 1500);
    return;
  }

  const box=document.getElementById("subjects");
  SUBJECTS.forEach(s=>{
    const b=document.createElement("button");
    b.innerText=s;
    b.onclick=()=>{
      document.querySelectorAll(".subjects button").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      subject=s;
    };
    box.appendChild(b);
  });
}

async function send(){
  if(!subject || !text.value) return alert("教科と内容を入力してください");
  await post({
    action:"addHomework",
    subject,
    text: text.value,
    date: date.value,
    userId
  });
  alert("登録しました");
  liff.closeWindow();
}

init();
</script>
</body>
</html>

