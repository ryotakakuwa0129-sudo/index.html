<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å®¿é¡Œè¿½åŠ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 12px; }
    .subject-btn { margin: 4px 2px; padding: 8px; min-width: 60px; }
    input, button { margin: 6px 0; padding: 8px; width: 100%; }
  </style>
</head>
<body>
  <h2>ğŸ“˜ å®¿é¡Œè¿½åŠ </h2>
  <div id="status">èª­ã¿è¾¼ã¿ä¸­...</div>

  <h3>â• æ•™ç§‘ã‚’é¸æŠ</h3>
  <div id="subjects">
    <button class="subject-btn" data-subject="å›½èª">å›½èª</button>
    <button class="subject-btn" data-subject="ç®—æ•°">ç®—æ•°</button>
    <button class="subject-btn" data-subject="ç†ç§‘">ç†ç§‘</button>
    <button class="subject-btn" data-subject="ç¤¾ä¼š">ç¤¾ä¼š</button>
    <button class="subject-btn" data-subject="è‹±èª">è‹±èª</button>
    <button class="subject-btn" data-subject="éŸ³æ¥½">éŸ³æ¥½</button>
    <button class="subject-btn" data-subject="ç¾è¡“">ç¾è¡“</button>
    <button class="subject-btn" data-subject="ä¿ä½“">ä¿ä½“</button>
    <button class="subject-btn" data-subject="ãã®ä»–">ãã®ä»–</button>
  </div>

  <h3>å†…å®¹</h3>
  <input id="text" placeholder="å®¿é¡Œå†…å®¹">
  <input id="date" type="date">
  <button id="addBtn">è¿½åŠ </button>

<script>
const GAS_URL = "GAS_WEB_APP_URL";
const LIFF_ID = "LIFF_ID";

let selectedSubject = "";
let userId = "";

async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    userId = liff.getContext().userId;
    const res = await post({ action: "checkUser", userId });
    if (!res.registered) {
      window.location.href = "register.html"; // æœªç™»éŒ²ãªã‚‰ç™»éŒ²ç”»é¢ã¸
      return;
    }
    document.getElementById("status").innerText = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªæ¸ˆã¿";
  } catch (e) {
    console.error(e);
    document.getElementById("status").innerText = "åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼";
  }
}

function post(data) {
  return fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  }).then(res => res.json());
}

// æ•™ç§‘ãƒœã‚¿ãƒ³é¸æŠ
document.querySelectorAll(".subject-btn").forEach(btn => {
  btn.onclick = () => {
    selectedSubject = btn.dataset.subject;
    document.getElementById("status").innerText = "é¸æŠ: " + selectedSubject;
  };
});

// è¿½åŠ ãƒœã‚¿ãƒ³
document.getElementById("addBtn").onclick = async () => {
  const text = document.getElementById("text").value;
  const date = document.getElementById("date").value;

  if (!selectedSubject || !text || !date) {
    alert("æ•™ç§‘ãƒ»å†…å®¹ãƒ»æœŸé™ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const res = await post({
    action: "addHomework",
    userId,
    subject: selectedSubject,
    text,
    date
  });

  if (res.ok) {
    alert("å®¿é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ");
    liff.closeWindow(); // è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
  } else {
    alert("è¿½åŠ å¤±æ•—");
  }
};

init();
</script>
</body>
</html>
