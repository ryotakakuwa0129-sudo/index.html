<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>宿題完了登録</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:sans-serif;padding:20px;}
button{margin:5px;padding:8px 12px;}
label{display:block;margin:5px;}
.fade-in{animation:fadeIn 0.5s;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
</style>
</head>
<body class="fade-in">
<h2>宿題完了登録</h2>
<div id="hwList"></div>
<button id="doneBtn">完了登録</button>

<script>
let liffId="YOUR_LIFF_ID";

async function main(){
  await liff.init({ liffId });
  const userId=liff.getContext().userId;

  // 未登録なら登録画面に
  const resCheck = await fetch(liff.getOS()+'/liffApi',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'checkUser', userId })
  });
  const dataCheck = await resCheck.json();
  if(!dataCheck.registered){ window.location.href='register.html'; return; }

  // 未完了宿題取得
  const res = await fetch(liff.getOS()+'/liffApi',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'getUndoneHomework', userId })
  });
  const data = await res.json();
  const hwListDiv = document.getElementById('hwList');
  data.forEach((hw,i)=>{
    const label = document.createElement('label');
    label.innerHTML=`<input type="checkbox" value="${hw}"> ${hw}`;
    hwListDiv.appendChild(label);
  });
}

document.getElementById('doneBtn').addEventListener('click', async()=>{
  const userId=liff.getContext().userId;
  const doneList=Array.from(document.querySelectorAll('#hwList input:checked')).map(i=>i.value);
  if(doneList.length===0){ alert('宿題を選択してください'); return; }

  await fetch(liff.getOS()+'/liffApi',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'doneHomework', userId, doneList })
  });
  alert('完了登録しました');
  liff.closeWindow();
});

main();
</script>
</body>
</html>


